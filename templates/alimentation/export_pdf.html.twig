<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rapport des Alimentations - Progress Engineering</title>
    <style>
        @page {
            margin: 1.5cm;
            size: A4 landscape;
        }

        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 9pt;
            line-height: 1.4;
            color: #333;
            margin: 0;
            padding: 0;
            background-color: #fff;
        }

        .header {
            background: linear-gradient(135deg, #0091d4 0%, #0077b3 100%);
            color: white;
            padding: 20px 30px;
            margin: -1.5cm -1.5cm 20px -1.5cm;
            text-align: left;
            border-radius: 0 0 10px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content { flex: 1; }

        .header h1 {
            margin: 0 0 5px 0;
            font-size: 22pt;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .header .subtitle {
            font-size: 11pt;
            opacity: 0.9;
            margin: 0;
            font-weight: 300;
        }

        .logo { width: 80px; height: auto; opacity: 0.9; }

        .summary-section {
            background: #f8fafc;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0091d4;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 12px;
        }

        .summary-item {
            text-align: center;
            padding: 12px 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .summary-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .summary-label { font-size: 9pt; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; font-weight: 500; }
        .summary-value { font-size: 16pt; font-weight: 600; color: #0091d4; margin: 5px 0; }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 15px 0 25px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 9pt;
        }

        .data-table th { background: linear-gradient(135deg, #0091d4 0%, #0077b3 100%); color: white; padding: 10px 12px; text-align: left; font-weight: 500; font-size: 9pt; text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table td { padding: 10px 12px; border-bottom: 1px solid #f0f4f8; font-size: 9pt; vertical-align: middle; }
        .data-table tbody tr:nth-child(even) { background-color: #f9fbfd; }
        .data-table tbody tr:hover { background-color: #f0f7ff; }

        .amount-cell { text-align: right; font-weight: 600; color: #e74c3c; font-family: 'Courier New', monospace; }

        .footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #e9ecef; text-align: center; font-size: 8pt; color: #a0a0a0; }
        .page-info { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }

        .watermark { position: fixed; bottom: 30%; right: 10%; opacity: 0.04; font-size: 120pt; color: #0091d4; transform: rotate(-30deg); z-index: -1; pointer-events: none; font-weight: 800; white-space: nowrap; }

        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 8pt; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-primary { background-color: #e6f3fb; color: #0077b3; }
    </style>
</head>
<body>
    <div class="watermark">PROGRESS ENGINEERING</div>

    <div class="header">
        <div class="header-content">
            <h1>Rapport des Alimentations</h1>
            <p class="subtitle">Analyse d√©taill√©e des entr√©es de fonds</p>
            <p class="subtitle">G√©n√©r√© le {{ 'now'|date('d/m/Y \\√† H:i') }} | P√©riode: 
                {% if dateRange.exportAll %}
                    Toutes les donn√©es
                {% else %}
                    Du {{ dateRange.min|date('d/m/Y') }} au {{ dateRange.max|date('d/m/Y') }}
                {% endif %}
            </p>
        </div>
        <div style="text-align: right;">
            <div style="background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 6px; display: inline-block;">
                <div style="font-size: 18pt; font-weight: 700; line-height: 1;">PE</div>
                <div style="font-size: 8pt; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">ENGINEERING</div>
            </div>
        </div>
    </div>

    {% if data is not empty %}
        <!-- Section R√©sum√© Statistique -->
        <div class="summary-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #0091d4; font-size: 14pt; font-weight: 600;">
                    <span style="background: #e6f3fb; padding: 5px 10px; border-radius: 20px; display: inline-flex; align-items: center;">
                        <span style="display: inline-block; width: 8px; height: 8px; background: #0091d4; border-radius: 50%; margin-right: 8px;"></span>
                        R√âSUM√â STATISTIQUE
                    </span>
                </h2>
                <div style="font-size: 9pt; color: #a0a0a0;">
                    <span class="badge badge-primary">{{ stats.count }} op√©rations</span>
                </div>
            </div>
            
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">Montant Total</div>
                    <div class="summary-value">{{ stats.total|number_format(3, ',', ' ') }} <span style="font-size: 10pt; color: #a0a0a0;">TND</span></div>
                    <div style="font-size: 8pt; color: #27ae60; margin-top: 3px;">
                        <i class="fas fa-chart-line" style="margin-right: 3px;"></i>
                        {{ (stats.average * stats.count)|number_format(2, ',', ' ') }} TND en moyenne
                    </div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">Montant Moyen</div>
                    <div class="summary-value">{{ stats.average|number_format(3, ',', ' ') }} <span style="font-size: 10pt; color: #a0a0a0;">TND</span></div>
                    <div style="font-size: 8pt; color: #f39c12; margin-top: 3px;">
                        <i class="fas fa-info-circle" style="margin-right: 3px;"></i>
                        Par op√©ration
                    </div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">Montant Maximum</div>
                    <div class="summary-value" style="color: #e74c3c;">{{ stats.max|number_format(3, ',', ' ') }} <span style="font-size: 10pt; color: #a0a0a0;">TND</span></div>
                    <div style="font-size: 8pt; color: #a0a0a0; margin-top: 3px;">
                        <i class="fas fa-arrow-up" style="margin-right: 3px;"></i>
                        Plus haute alimentation
                    </div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-label">Montant Minimum</div>
                    <div class="summary-value" style="color: #27ae60;">{{ stats.min|number_format(3, ',', ' ') }} <span style="font-size: 10pt; color: #a0a0a0;">TND</span></div>
                    <div style="font-size: 8pt; color: #a0a0a0; margin-top: 3px;">
                        <i class="fas fa-arrow-down" style="margin-right: 3px;"></i>
                        Plus basse alimentation
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section Analyse par P√©riode -->
        {% if stats.parPeriode is not empty %}
        <div class="summary-section" style="border-left-color: #17a2b8;">
            <h2 style="margin: 0 0 15px 0; color: #17a2b8; font-size: 14pt;">üìÖ √âvolution Mensuelle</h2>
            <table style="width: 100%; font-size: 10pt;">
                <thead>
                    <tr style="background: #17a2b8; color: white;">
                        <th style="padding: 8px;">Mois</th>
                        <th style="padding: 8px; text-align: center;">Nombre</th>
                        <th style="padding: 8px; text-align: right;">Montant Total</th>
                        <th style="padding: 8px; text-align: right;">Montant Moyen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for periode, stat in stats.parPeriode %}
                    <tr>
                        <td style="padding: 6px;">{{ periode }}</td>
                        <td style="padding: 6px; text-align: center;">{{ stat.count }}</td>
                        <td style="padding: 6px; text-align: right;">{{ stat.total|number_format(3, ',', ' ') }} TND</td>
                        <td style="padding: 6px; text-align: right;">{{ (stat.total / stat.count)|number_format(3, ',', ' ') }} TND</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
        <!-- Section Informations de P√©riode -->
        <div class="summary-section" style="border-left-color: #6f42c1;">
            <h2 style="margin: 0 0 15px 0; color: #6f42c1; font-size: 14pt;">üóìÔ∏è P√©riode d'Analyse</h2>
            <p style="margin: 5px 0; font-size: 11pt;">
                <strong>Type d'export:</strong>
                {% if dateRange.exportAll %}
                    Toutes les alimentations disponibles
                {% else %}
                    P√©riode personnalis√©e
                    {% if dateRange.min %} du {{ dateRange.min|date('d/m/Y') }}{% endif %}
                    {% if dateRange.max %} au {{ dateRange.max|date('d/m/Y') }}{% endif %}
                {% endif %}
            </p>
            <p style="margin: 5px 0; font-size: 11pt;">
                <strong>Alimentation moyenne:</strong> {{ (stats.total / stats.count)|number_format(3, ',', ' ') }} TND par alimentation
            </p>
        </div>
    {% endif %}

    <!-- Tableau des donn√©es -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px 0;">
        <h2 style="margin: 0; color: #2c3e50; font-size: 14pt; font-weight: 600;">
            <span style="background: #f0f4f8; padding: 5px 12px; border-radius: 20px; display: inline-flex; align-items: center;">
                <span style="display: inline-block; width: 8px; height: 8px; background: #f7a81b; border-radius: 50%; margin-right: 8px;"></span>
                D√âTAIL DES ALIMENTATIONS
            </span>
        </h2>
        <div style="font-size: 9pt; color: #a0a0a0; background: #f8fafc; padding: 4px 10px; border-radius: 4px;">
            <i class="fas fa-info-circle" style="margin-right: 5px; color: #0091d4;"></i>
            {{ data|length }} op√©rations affich√©es
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                {% for header in headers %}
                    <th {% if loop.index == 3 %}style="text-align: right;"{% endif %}>{{ header }}{% if loop.index == 3 %} <span style="font-weight: normal; opacity: 0.8;">(TND)</span>{% endif %}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
                <tr>
                    {% for cell in row %}
                        {% if loop.index == 3 %}
                            <td class="amount-cell">{{ cell|number_format(3, ',', ' ') }}</td>
                        {% else %}
                            <td>
                                {% if loop.index == 1 %}
                                    <div style="display: flex; align-items: center;">
                                        <div style="background: #e6f3fb; color: #0077b3; width: 24px; height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 10px; font-weight: 600;">
                                            {{ cell|slice(0, 2) }}
                                        </div>
                                        <div>
                                            <div style="font-weight: 500;">{{ cell|slice(11, 5) }}</div>
                                            <div style="font-size: 8px; color: #a0a0a0; line-height: 1;">{{ cell|slice(3, 2) ~ '/' ~ cell|slice(6, 4) }}</div>
                                        </div>
                                    </div>
                                {% else %}
                                    {{ cell }}
                                {% endif %}
                            </td>
                        {% endif %}
                    {% endfor %}
                </tr>
            {% else %}
                <tr>
                    <td colspan="{{ headers|length }}" style="text-align: center; padding: 30px; color: #666; font-style: italic;">
                        Aucune alimentation trouv√©e pour la p√©riode s√©lectionn√©e
                    </td>
                </tr>
            {% endfor %}
        </tbody>
        {% if data is not empty %}
            <tfoot>
                <tr>
                    <td colspan="{{ headers|length - 1 }}" style="text-align: right; font-weight: 600; color: #2c3e50;">TOTAL G√âN√âRAL</td>
                    <td class="amount-cell" style="font-size: 10.5pt; background-color: #f8fafc; border-top: 2px solid #e9ecef;">
                        {{ stats.total|number_format(3, ',', ' ') }} <span style="font-size: 9pt; color: #a0a0a0;">TND</span>
                    </td>
                </tr>
            </tfoot>
        {% endif %}
    </table>

    <div class="footer">
        <div style="margin-bottom: 8px;">
            <span style="color: #0091d4; font-weight: 500;">Progress Engineering</span> ‚Ä¢ 
            <span style="color: #a0a0a0;">Rapport confidentiel - Usage interne uniquement</span>
        </div>
        <div class="page-info">
            <span>G√©n√©r√© le {{ "now"|date("d/m/Y \\√† H:i") }} par {{ app.user ? app.user.email : 'Syst√®me' }}</span>
            <span>Page <span class="page-number"></span> ‚Ä¢ {{ "now"|date("Y") }}, Tous droits r√©serv√©s</span>
        </div>
    </div>
    
    <script type="text/php">
        if (isset($pdf)) {
            $text = "Page {PAGE_NUM} / {PAGE_COUNT}";
            $size = 8;
            $font = $fontMetrics->getFont('helvetica');
            $width = $fontMetrics->get_text_width($text, $font, $size) / 2;
            $x = ($pdf->get_width() - $width) / 2;
            $y = $pdf->get_height() - 15;
            $pdf->page_text($x, $y, $text, $font, $size, array(0.6, 0.6, 0.6));
        }
    </script>
</body>
</html>
